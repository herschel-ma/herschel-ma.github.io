---
title: "å…³äºclassLoader"
date: 2021-02-13T10:39:35+08:00
description: "classLoader çš„å¸¸ç”¨æ–¹æ³•åŠè·å–æ–¹æ³•"
draft: false
hideToc: false
enableToc: true
enableTocContent: true
author: Herschel
authorEmoji: ğŸ…
pinned: false
tags:
- JVM
- Java
series:
-
categories:
- Java
image: images/JVM/åŒäº²å§”æ´¾æœºåˆ¶.png
---
## å…³äºclassLoader
- ClassLoader ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿è‡ª ClassLoader (ä¸åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨)ã€‚
- æ¦‚è§ˆ

| æ–¹æ³•åç§°                                            | æè¿°                                                                         |
| -------------                                       | -------------                                                                |
| getParent()                                         | è¿”å›è¯¥ç±»åŠ è½½å™¨çš„è¶…ç±»åŠ è½½å™¨                                                   |
| loadClass(String name)                              | åŠ è½½åä¸º name çš„ç±»ï¼Œè¿”å›ç»“æœä¸º java.lang.Class ç±»çš„å®ä¾‹                      |
| findClass(String name)                              | æŸ¥æ‰¾åä¸º name çš„ç±»ï¼Œè¿”å›ç»“æœä¸º java.lang.Class ç±»çš„å®ä¾‹                      |
| findLoadedClass(String name)                        | æŸ¥æ‰¾åä¸º name çš„å·²ç»è¢«åŠ è½½è¿‡çš„ç±»ï¼Œè¿”å›ç»“æœä¸º java.lang.Class ç±»çš„å®ä¾‹        |
| defineClass(String name,byte[] b, int off, int len) | æŠŠå­—èŠ‚æ•°ç»„ä¸­ b çš„å†…å®¹è½¬æ¢ä¸ºä¸€ä¸ª Java ç±»ï¼Œè¿”å›ç»“æœä¸º java.lang.Class ç±»çš„å®ä¾‹ |
| findLoadedClass(String name)                        | æŸ¥æ‰¾åä¸º name çš„å·²ç»è¢«åŠ è½½è¿‡çš„ç±»ï¼Œè¿”å›ç»“æœä¸º java.lang.Class ç±»çš„å®ä¾‹        |

## è·å– classLoader çš„é€”å¾„
1. è·å–å½“å‰ç±»çš„ classLoader
`class.getClassLoader()`

2. è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ ClassLoader
`Thread.currentThread().getContextClassLoader()`

3. è·å–ç³»ç»Ÿçš„ ClassLoader
`ClassLoader.getSystemClassLoader()`

4. è·å–è°ƒç”¨è€…çš„ ClassLoader
`DriverManager.getCallerClassLoader()`

```java
public classLoaderTest {
    public static void main (String[] args) {
        try{
            ClassLoader classLoader = Class.forName("java.lang.String").getClassLoader();
            System.out.println(classLoader);

            ClassLoader classLoader1 = Thread.currentThread.getContextClassLoader();
            System.out.println(classLoader1);

            ClassLoader classLoader2 = ClassLoader.getSystemClassLoader.getParent();
            System.out.println(classLoader2);
        }catch(ClassNotFountException e){
            e.printStackTrace();
        }
    }
}

```

## åŒäº²å§”æ´¾æœºåˆ¶
### ç®€ä»‹
- Javaè™šæ‹Ÿæœºå¯¹ class æ–‡ä»¶é‡‡å–çš„æ˜¯`æŒ‰éœ€åŠ è½½`çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å½“éœ€è¦ä½¿ç”¨è¯¥ç±»æ—¶æ‰å°†å®ƒçš„ class æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ç”Ÿæˆ class å¯¹è±¡ã€‚è€Œä¸”åŠ è½½æŸä¸ª class æ–‡ä»¶æ—¶ï¼ŒJavaè™šæ‹Ÿæœºé‡‡ç”¨çš„æ˜¯`åŒäº²å§”æ´¾æ¨¡å¼`ï¼Œå³æŠŠè¯·æ±‚äº¤ç»™çˆ¶ç±»å¤„ç†ï¼Œå®ƒæ˜¯ä¸€ç§ä»»åŠ¡å§”æ´¾æ¨¡å¼ã€‚

### å·¥ä½œåŸç†
![åŒäº²å§”æ´¾æœºåˆ¶](/images/JVM/åŒäº²å§”æ´¾æœºåˆ¶.png)

1. å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œä»–ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œï¼›
2. å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼›æœ€ç»ˆè¯·æ±‚å°†ä¼šåˆ°è¾¾é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼›
3. å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå¦åˆ™æ‰å°è¯•è‡ªå·±åŠ è½½ï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾æœºåˆ¶ã€‚

### ä¼˜åŠ¿
1. é¿å…ç±»çš„é‡å¤åŠ è½½
2. ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢æ ¸å¿ƒ API è¢«ç¯¡æ”¹
    - è‡ªå®šä¹‰ç±» java.lang.String
    - è‡ªå®šä¹‰ç±» java,lang.ShkStart

### æ²™ç®±å®‰å…¨æœºåˆ¶
- è‡ªå®šä¹‰ String ç±»ï¼Œä½†æ˜¯åœ¨åŠ è½½è‡ªå®šä¹‰ String ç±»çš„æ—¶å€™ä¼šç‡å…ˆä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œå¼•å¯¼ç±»åŠ è½½å™¨åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ä¼šå…ˆåŠ è½½jdkè‡ªå¸¦çš„æ–‡ä»¶ï¼ˆrt.jaråŒ…ä¸­çš„ java/lang/String.classï¼‰ï¼ŒæŠ¥é”™ä¿¡æ¯è¯´æ²¡æœ‰mainæ–¹æ³•ï¼Œå°±æ˜¯å› ä¸ºåŠ è½½çš„æ˜¯ rt.jar åŒ…ä¸­çš„ String ç±»ã€‚è¿™æ ·å¯ä»¥ä¿è¯å¯¹ java æ ¸å¿ƒæºä»£ç çš„ä¿æŠ¤ï¼Œè¿™å°±æ˜¯`æ²™ç®±å®‰å…¨æœºåˆ¶`ã€‚

## å…¶ä»–
- åœ¨ JVM ä¸­è¡¨ç¤ºä¸¤ä¸ª class å¯¹è±¡æ˜¯å¦æ˜¯åŒä¸€ä¸ªç±»å­˜åœ¨ä¸¤ä¸ªå¿…è¦æ¡ä»¶ï¼š
    1. ç±»çš„å®Œæ•´ç±»åå¿…é¡»ä¸€è‡´ï¼ŒåŒ…æ‹¬åŒ…åã€‚
    2. åŠ è½½è¿™ä¸ªç±»çš„ ClassLoaderï¼ˆæŒ‡ ClassLoader å®ä¾‹å¯¹è±¡ï¼‰å¿…é¡»ç›¸åŒã€‚

- æ¢å¥è¯è¯´ï¼Œåœ¨ JVM ä¸­ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»å¯¹è±¡æ¥æºäºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹Ÿæœºæ‰€åŠ è½½ï¼Œä½†åªè¦åŠ è½½ä»–ä»¬çš„ ClassLoader å®ä¾‹å¯¹è±¡ä¸åŒï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å¯¹è±¡ä¹Ÿæ˜¯ä¸ç›¸ç­‰çš„ã€‚

## ç±»åŠ è½½å™¨çš„å¼•ç”¨
- JVM å¿…é¡»çŸ¥é“ä¸€ä¸ªç±»å‹æ˜¯ç”±å¯åŠ¨åŠ è½½å™¨åŠ è½½çš„è¿˜æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ã€‚å¦‚æœä¸€ä¸ªç±»å‹æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œé‚£ä¹ˆ JVM ä¼šå°†è¿™ä¸ªç±»åŠ è½½å™¨çš„ä¸€ä¸ªå¼•ç”¨ä½œä¸ºç±»å‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†åŒ…å­˜åœ¨æ–¹æ³•åŒºä¸­ã€‚å½“è§£æä¸€ä¸ªç±»å‹åˆ°å¦ä¸€ä¸ªç±»å‹çš„å¼•ç”¨çš„æ—¶å€™ï¼ŒJVM éœ€è¦ä¿è¯è¿™ä¸¤ä¸ªç±»å‹çš„ç±»åŠ è½½å™¨æ˜¯ç›¸åŒçš„ã€‚

## ç±»çš„ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨
**Java ç¨‹åºå¯¹ç±»çš„ä½¿ç”¨æ–¹å¼åˆ†ä¸ºï¼šä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨ã€‚**

- ä¸»åŠ¨ä½¿ç”¨ï¼Œåˆåˆ†ä¸º7ç§æƒ…å†µï¼š
    - åˆ›å»ºç±»çš„å®ä¾‹
    - è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼
    - è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•
    - åå°„ï¼ˆæ¯”å¦‚ï¼šClass.forName('java.lang.String')
    - åˆå§‹åŒ–ä¸€ä¸ªç±»çš„å­ç±»
    - Java è™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»
    - JDK7 å¼€å§‹æä¾›çš„åŠ¨æ€è¯­è¨€æ”¯æŒï¼šjava.lang.invoke.MethodHandleå®ä¾‹çš„è§£æç»“æœã€REF_getStaticã€REF_invokeStatic å¥æŸ„å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–

- é™¤äº†ä»¥ä¸Šä¸ƒç§æƒ…å†µï¼Œå…¶ä»–ä½¿ç”¨ Java ç±»çš„æ–¹å¼éƒ½è¢«çœ‹ä½œæ˜¯å¯¹**ç±»çš„è¢«åŠ¨ä½¿ç”¨**ï¼Œéƒ½**ä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–**ã€‚
